# Frontend CI Workflow Documentation

## Overview

The `frontend-ci.yml` workflow provides comprehensive CI/CD for the Skillshub UI frontend application, including
linting, unit tests, E2E tests, and code quality analysis.

## Workflow Features

### ðŸ”„ Automatic Triggers

- **Push** to `dev` or `main` branches
- **Pull Requests** targeting `dev` or `main` branches

### ðŸ—ï¸ Build Pipeline

#### 1. **Setup**

- Checkout code with full git history (`fetch-depth: 0` for SonarQube)
- Setup Node.js v20 with npm cache
- Install dependencies with `npm ci` (clean install)

#### 2. **Code Quality**

- **Lint**: `npm run lint` - ESLint checks
- **Unit Tests**: `npm run test:coverage` - Vitest with coverage
- **Build**: `npm run build` - TypeScript compilation + Vite build

#### 3. **E2E Tests**

- **Tool**: Cypress (via `cypress-io/github-action@v6`)
- **Mode**: Headless with Chrome browser
- **Server**: Preview build on `http://localhost:4173`
- **Wait Strategy**: Waits up to 120s for server to be ready
- **No Backend**: All API calls mocked with `cy.intercept()`

#### 4. **Artifacts**

- Cypress screenshots (on failure only)
- Cypress videos (on failure only)
- Retained for 30 days by default

#### 5. **Code Analysis**

- **Tool**: SonarQube Cloud
- **Coverage**: Reads `coverage/lcov.info` from Vitest
- **Metrics**: Code smells, bugs, vulnerabilities, coverage

## Key Configuration Details

### Preview Server Command

```bash
npm run preview -- --host 0.0.0.0 --port 4173 --strictPort
```

**Why these flags?**

- `--host 0.0.0.0`: Bind to all network interfaces (required in CI)
- `--port 4173`: Explicit port (Vite preview default)
- `--strictPort`: Fail if port is already in use (prevents silent fallback)

### Cypress Configuration

```yaml
uses: cypress-io/github-action@v6
with:
  start: npm run preview -- --host 0.0.0.0 --port 4173 --strictPort
  wait-on: http://localhost:4173
  wait-on-timeout: 120
  browser: chrome
  install: false  # Already installed by npm ci
```

### Why `install: false`?

Dependencies are already installed by `npm ci` in a previous step, so Cypress action doesn't need to reinstall.

## Concurrency Control

```yaml
concurrency:
  group: frontend-ci-${{ github.ref }}
  cancel-in-progress: true
```

**Benefit**: Cancels old pipeline runs when new commits are pushed to the same branch, saving CI minutes.

## Environment Variables

### Required Secrets

Configure in GitHub repository settings (`Settings > Secrets and variables > Actions`):

- `SONAR_TOKEN` - Authentication token from SonarCloud
- `SONAR_PROJECT_KEY` - Your SonarCloud project key
- `SONAR_ORG` - Your SonarCloud organization name

## Test Strategy

### Unit/Integration Tests (Vitest)

- **Location**: `src/**/*.test.{ts,tsx}`
- **Coverage**: LCOV format in `coverage/lcov.info`
- **Reporter**: Console + coverage report

### E2E Tests (Cypress)

- **Location**: `cypress/e2e/**/*.cy.ts`
- **Strategy**: Mock all backend API calls
- **Tests**:
    - Session expired flow (401)
    - Protected route redirects
    - (Add more as needed)

### No Backend Required

All E2E tests use `cy.intercept()` to mock:

- Authentication endpoints (`/api/auth/me`, `/api/users/me`)
- Business endpoints (`/api/course`, etc.)
- Login redirects (`/api/auth/login`)

## Troubleshooting

### Cypress Timeout

If Cypress times out waiting for the server:

1. Check build succeeded
2. Verify preview server starts correctly
3. Increase `wait-on-timeout` if needed

### SonarQube Scan Fails

- Verify all three secrets are set correctly
- Check SonarCloud project exists
- Ensure `coverage/lcov.info` was generated by tests

### Artifacts Not Uploaded

- Artifacts only upload on `failure()`
- Check workflow logs for actual failures
- Verify paths exist: `cypress/screenshots`, `cypress/videos`

## Local Testing

### Run the full pipeline locally:

```bash
# 1. Install dependencies
npm ci

# 2. Lint
npm run lint

# 3. Unit tests with coverage
npm run test:coverage

# 4. Build
npm run build

# 5. Preview + E2E (in separate terminals)
npm run preview -- --host 0.0.0.0 --port 4173 --strictPort
npm run cypress:run

# Or combined (requires start-server-and-test):
npm install -D start-server-and-test
npx start-server-and-test "npm run preview -- --host 0.0.0.0 --port 4173 --strictPort" http://localhost:4173 "npm run cypress:run"
```

## Performance

### Typical Run Time

- Setup: ~30s
- Install: ~45s
- Lint: ~10s
- Tests: ~30s
- Build: ~60s
- E2E: ~90s
- SonarQube: ~30s

**Total**: ~5-6 minutes

### Optimization Tips

- Node cache speeds up npm ci
- Concurrency cancels old runs
- Cypress install: false saves ~20s
- Build artifacts cached by Vite

## Maintenance

### Updating Dependencies

```bash
# Update Cypress
npm update cypress

# Update GitHub Actions
# Edit .github/workflows/frontend-ci.yml
# cypress-io/github-action@v6 â†’ @v7 (when available)
```

### Adding New E2E Tests

1. Create `cypress/e2e/your-test.cy.ts`
2. Mock all backend calls with `cy.intercept()`
3. Push to dev branch
4. CI will automatically run new tests

## References

- [Cypress GitHub Action](https://github.com/cypress-io/github-action)
- [SonarQube GitHub Action](https://github.com/SonarSource/sonarqube-scan-action)
- [Vite Preview CLI](https://vitejs.dev/guide/cli.html#vite-preview)

---

**Status**: âœ… Workflow is production-ready and fully tested.
